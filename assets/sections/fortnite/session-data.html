<template class="task-template">
    <section id="Fortnite-session-data-section" class="section js-section u-category-session-data">
        <script type="text/javascript">
            // eventually we're going to want to connect to database in a seperate
            // js file so we can avoid code duplication
            let table = require('./assets/sections/tables')

                    'use strict';
                    const fs = require('fs');
                    // the path below will not work on your machine

                    var path = __dirname
                    var dashChecker = 0
                    var newPath
                    //console.log(path)

                    for(var x = 0; x < path.length; x++)
                    {
                        if (path.charAt(x) == '/')
                        {
                            dashChecker++
                        }
                        if(path.charAt(x) == '/' && dashChecker == 3)
                        {
                            newPath = path.substring(0, x+1)
                        }
                    }

                    console.log(newPath)


                    let files = fs.readdirSync(newPath + 'AppData/Local/FortniteGame/Saved/Demos');

                    console.log(files.length)

                    let i = 1
                    let id = 0
                    var mysql = require('mysql');
                    var connection = mysql.createConnection({
                       host: "remotemysql.com",
                       user: "LxpYo6DXca",
                       password: "sDRWmqCi5P",
                       database: "LxpYo6DXca"
                   });

                    //Array for storing data from database
                    let FortNiteData = [0, 0, 0, 0, 0, 0]
                    //Counter to iterate through columns in database
                    let ctr = 0;

                    //Counter for data to be placed in html code
                    let iterate = 0;

                    //Need to put # of replay files in database (8 files = 9 files)

                        function FNload1()
                        {
                            //Check to see current replay files
                            fs.readdir(newPath + 'AppData/Local/FortniteGame/Saved/Demos', (err, files) => 
                            {
                              console.log("Num of replay files" + files.length)
                              localStorage.setItem("FN_Local_Files", files.length);


                              //Give permission to update columns in database
                          var sql_SAFE = "SET SQL_SAFE_UPDATES = 0"
                          connection.query(sql_SAFE, function (err, result)
                          {
                              if(err)
                              {
                                  console.log("An error ocurred performing the query.");
                                  console.log(err);
                                  return;
                              }
                              console.log("CSGO SAFE Query succesfully executed");
                          });

                          //Checks numFiles that is in database
                         const query2 = "SELECT numFiles FROM new_table2"
                         connection.query(query2, function (err, result, fields) 
                         {
                            if (err) throw err;
                            console.log("Fortnite numFiles Checked")
                            localStorage.setItem("FN_DB_Files", result[0].numFiles);

                        });

                    });
                         //Don't know why length in folder is 2 but says there are 3...
                         FNnumFiles1 = (localStorage.getItem("FN_Local_Files"))
                         FNnumFiles2 = localStorage.getItem("FN_DB_Files")


                    }

                  function FNload2()
                  {
                    console.log("NUMBER OF FILESSS:" + FNnumFiles1)

                    //Update database if new replay files were added, else just display tables 
                    if(FNnumFiles1 != FNnumFiles2)
                    {
                      //ipc.send('entry-accepted', 'ping4');
                      var sql3 = mysql.format("UPDATE new_table2 SET numFiles" + "='" + FNnumFiles1 + "' WHERE id = 1")

                      // execute the insert statement
                      connection.query(sql3, function (err, result)
                      {
                          if(err)
                          {
                              console.log("An error ocurred performing the query.");
                              console.log(err);
                              return;
                          }
                          console.log("CSGO UPDATE Query succesfully executed");
                      });

                    files.forEach(fileName =>
                    {
                        let {PythonShell} = require('python-shell')

                        let options = {
                            args: [fileName]
                        };

                        let fields = ["eliminations", "assists", "revives", "accuracy", "damage taken", "place"]

                        var today = new Date();
                        var date = (today.getMonth()+1)+'-'+ today.getDate() +'-'+ today.getFullYear();
                        var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
                        var dateTime = date +' '+ time;
                        console.log(dateTime)

                        PythonShell.run('./ForniteAPI/src/Main.py', options, function  (err, results)  
                        {
                            if  (err)  throw err;

                          //Writes data to database
                          var sql = mysql.format("INSERT INTO stats (id, eliminations,assists,revives,accuracy,damage_taken, place, timestamp) VALUES (?, ?, ?, ? ,?, ?, ?,?)", [ctr, results[0], results[1], results[2], results[3], results[4], results[5], dateTime]);
                          ctr++;
                          // execute the insert statement
                          connection.query(sql, function (err, result)
                          {
                              if(err)
                              {
                                  console.log("An error ocurred performing the query.");
                                  console.log(err);
                                  return;
                              }
                              console.log("Fortnite INSERT Query succesfully executed");
                              ipc.sendSync('entry-accepted', 'ping3');
                          });
                      });
                    });
                  }
                  else
                  {
                  //Put data from database into tables
                  connection.connect(function(err)
                  {
                      if (err) throw err;

                      //console.log("connected")

                      const query = "SELECT PLACE, ASSISTS, REVIVES, ACCURACY, ELIMINATIONS, DAMAGE_TAKEN, ID, TIMESTAMP FROM stats"

                      connection.query(query, function (err, result, fields) {
                          if (err) throw err;
                          console.log("Fortnite querying...")
                          table.displaySessionData(result, fields, "Fortnite-session-data-section")
                          //table.createTable(result, fields)

                      });
                    });
                }
              }
              
              FNload1()
              FNload2()

        </script>
    </section>
</template>
