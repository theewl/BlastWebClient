<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

<template class="task-template">
    <section id="CS:GO-session-data-section" class="section js-section u-category-session-data">
        
            <script type="text/javascript">
                // eventually we're going to want to connect to database in a seperate
                // js file so we can avoid code duplication
                //let table = require('./assets/sections/tables')

                'use strict';
                var id2 = 0


                //PUT EACH REPLAY FILE INDIVIDUALLY INTO DATABASE
                //CHECK FOR IDS, IF ID IS ALRAEDY IN DATABASE, DONT RUN. IF ID IS GREATER THAN IDS, THEN RUN AND ADD. 
                    
                var jsgo = require('../BlastWebClient/assets/sections/jsgo');

                    //num of kills
                    var kills = 0;
                    //num of headshots
                    var headshots = 0;
                    //num of deaths
                    var deaths = 0;
                    //k/d ratio
                    var kd = 0;
                    //User's name
                    var username;
                    //To keep track of rounds
                    var previousRound = 0;
                    //Terriorist's score
                    var tSide = 0;
                    //CT's score
                    var ctSide = 0;
                    //current player's side
                    var currPlayerSide;
                    //win or lose?
                    var winLose;
                    var winLose2;
                    //local numFile
                    var numFiles1
                    //database numFile
                    var numFiles2

                    const testFolder = '../BlastWebClient/CSGO_Replays';
                function load1()
                {
                    //Check to see current replay files
                    fs.readdir(testFolder, (err, files) => 
                    {
                      console.log("Num of replay files" + files.length)
                      localStorage.setItem("CSGO_Local_Files", files.length);


                      //Give permission to update columns in database
                  var sql_SAFE = "SET SQL_SAFE_UPDATES = 0"
                  connection.query(sql_SAFE, function (err, result)
                  {
                      if(err)
                      {
                          console.log("An error ocurred performing the query.");
                          console.log(err);
                          return;
                      }
                      console.log("CSGO SAFE Query succesfully executed");
                  });

                  //Checks numFiles that is in database
                 const query2 = "SELECT numFiles FROM new_table"
                 connection.query(query2, function (err, result, fields) 
                 {
                    if (err) throw err;
                    console.log("CSGO numFiles Checked")
                    localStorage.setItem("CSGO_DB_Files", result[0].numFiles);

                });

            });
                 //Don't know why length in folder is 2 but says there are 3...
                 numFiles1 = (localStorage.getItem("CSGO_Local_Files") - 1)
                 numFiles2 = localStorage.getItem("CSGO_DB_Files")


            }   


                function load2()
                {

                    //Update database if new replay files were added, else just display tables 
                    if(numFiles1 != numFiles2)
                    {
                      ipc.send('entry-accepted', 'ping4');
                      var sql3 = mysql.format("UPDATE new_table SET numFiles" + "='" + numFiles1 + "' WHERE id = 1")

                      // execute the insert statement
                      connection.query(sql3, function (err, result)
                      {
                          if(err)
                          {
                              console.log("An error ocurred performing the query.");
                              console.log(err);
                              return;
                          }
                          console.log("CSGO UPDATE Query succesfully executed");
                      });
                    
                    fs.readdir(testFolder, (err, files) => 
                    {
                      
                      var file = files[files.length - 1]

                      
                        var today = new Date();
                        var date = (today.getMonth()+1)+'-'+ today.getDate() +'-'+ today.getFullYear();
                        var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
                        var dateTime = date +' '+ time;

                        fs.readFile(testFolder + file, function(err,data)
                        {
                            var myDemo = new jsgo.Demo().

                            //Checks event of each round
                            on('game.round_officially_ended', function(event) 
                            {
                                //Get teams 
                                var teams = this.getTeams();
                                //Get players
                                var player = this.getPlayers();
                                var currentPlayer = "";
                                var currentPos = 0;

                                //Loop to find the user's name
                                for ( var i = 0; i < 20; i++)
                                {
                                    //Find username in replay file
                                    if (player[i].getName() == "dennis")
                                    {
                                        currentPlayer = player[i].getName();
                                        currentPos = i;
                                        break;
                                        
                                    }
                                }

                                //Find the team that the user is in
                                //console.log(player[currentPos].getTeam(this)["classInfo"].name);

                                //if user is in CT, make that his/her current team
                                if(player[currentPos].getTeam(this)["classInfo"].name == 'CCSTeam')
                                {
                                    currPlayerSide = 'CT';
                                }
                                //if user is in terrorist, make that his/her current team
                                else
                                {
                                    currPlayerSide = 'TERRORIST';
                                }

                                //Checks rounds
                                //console.log('ROUND ' + (previousRound + 1));

                                previousRound = 0;
                                var teams = this.getTeams();

                                //Keeps track of score after each round
                                for (var i = 0; i < teams.length; i++) 
                                {

                                    var team = teams[i];
                                    var side = team.getSide();

                                    //Set scores to team variables
                                    if(team.getSide() == 'TERRORIST')
                                    {
                                        tSide = team.getScore();
                                    }
                                    else if (team.getSide() == 'CT')
                                    {
                                        ctSide = team.getScore();
                                    }

                                    //Iterate round
                                    previousRound += team.getScore();

                                    
                                }
                                //To display scores/round
                                //console.log('TERRORIST' + " " + tSide);
                                //console.log('CT' + " " + ctSide);

                                //0 = win, 1 = lose, 2 = tie
                                if(tSide < ctSide && currPlayerSide == 'TERRORIST')
                                {
                                    winLose = 0;
                                }
                                else if (ctSide < tSide && currPlayerSide == 'CT')
                                {
                                    winLose = 0;
                                }
                                else if (ctSide == tSide)
                                {
                                    winLose = 2
                                }
                                else
                                {
                                    winLose = 1;
                                }

                                //Player's username
                                username = player[currentPos].getName();
                                //console.log("\n"+ username);

                                //Headshots
                                headshots += player[currentPos].getRoundHeadshotKills();
                                //console.log("Headshots: " + headshots);

                                //Kills
                                kills += player[currentPos].getRoundKills();
                                //console.log("Kills: " + kills);

                            }).

                            //Checks event of each death
                            on('game.player_death', function(e) 
                            {
                                if (e.player != undefined)
                                {
                                    //console.log(e.player.getName());

                                    //If player's name is displayed, iterate death by 1
                                    if(e.player.getName() == 'dennis')
                                    {
                                        deaths++;
                                    }
                                }
                                
                                //Deaths
                                //console.log("Deaths: " + deaths);

                                //Calculate K/D
                                kd = (kills/deaths);
                                //console.log("K/D: " + kd);
                            }).

                            parse(data);
                            console.log("\n"+ username);
                            console.log("Deaths: " + deaths);
                            console.log("K/D: " + kd.toFixed(2));
                            console.log("Kills: " + kills);
                            console.log("Headshots: " + headshots);
                            console.log("Win/Lose/Tie: " + winLose);

                            if (winLose == 0)
                            {
                                winLose2 = "Won"
                            }
                            else if (winLose == 1)
                            {
                                winLose2 = "Lost"
                            }
                            else
                            {
                                winLose2 = "Tied"
                            }

                            const query4 = "SELECT id FROM CSGO_stats"
                            connection.query(query4, function (err, result, fields) 
                            {
                                if (err) throw err;

                                for(var p = 0; p<result.length; p++ )
                                {
                                    if (result[p].id == id2)
                                    {
                                        id2++
                                    }
                                }

                          //Writes data to database
                          var sql2 = mysql.format("INSERT INTO CSGO_stats (kills,deaths,kd,headshots,wtl,id, TIMESTAMP) VALUES (?, ?, ?, ? ,?, ?, ?)", [kills, deaths, kd.toFixed(2), headshots, winLose2, id2, dateTime]);
                          
                          // execute the insert statement
                          connection.query(sql2, function (err, result)
                          {
                              if(err)
                              {
                                  console.log("An error ocurred performing the query.");
                                  console.log(err);
                                  return;
                              }
                              console.log("CSGO INSERT Query succesfully executed");
                              ipc.sendSync('entry-accepted', 'ping3');
                          });
                      });
                    });      
                });
            }
                else
                {
                    const query2 = "SELECT kills, deaths, kd, headshots, wtl, TIMESTAMP FROM CSGO_stats"
                    connection.query(query2, function (err, result, fields) 
                    {
                        if (err) throw err;
                        console.log("CSGO querying...")
                        table.displaySessionData(result, fields, "CS:GO-session-data-section")

                    });
                }
            }
    load1()
    load2()
    //Rerun load function every minute
    var c = 0;
    var t;
    var timer_is_on = 0;
    var checker = 0;

    //Optional Refresh button
    function reloadTables()
    {
        ipc.sendSync('entry-accepted', 'ping3');
    }

    function timedCount() 
    {
        load1()
        loadIt()
        loadIt2()
        //If new replay file was added, run the function
        if((numFiles1 != numFiles2) && (checker == 1))
        {
            load2()
        }
        t = setTimeout(timedCount, 60000);
        checker = 1
    }

    function startCount() 
    {
      if (!timer_is_on) 
      {
        timer_is_on = 1;
        timedCount();
      }
    }

startCount();
                </script>

        </header>
    </section>


</template>
