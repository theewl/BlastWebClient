<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

<template class="task-template">
    <section id="CS:GO-session-data-section" class="section js-section u-category-session-data">

            <script type="text/javascript">
                // eventually we're going to want to connect to database in a seperate
                // js file so we can avoid code duplication
                //let table = require('./assets/sections/tables')

                'use strict';
                var id2 = 0

                //PUT EACH REPLAY FILE INDIVIDUALLY INTO DATABASE
                //CHECK FOR IDS, IF ID IS ALRAEDY IN DATABASE, DONT RUN. IF ID IS GREATER THAN IDS, THEN RUN AND ADD.

                var jsgo = require(newPath + 'Desktop\\blastwebclient-win32-x64\\resources\\app\\assets\\sections\\jsgo.js');

                    //Check if loggedIn
                    var loggedIn = 0
                    //num of kills
                    var kills = 0;
                    //num of headshots
                    var headshots = 0;
                    //num of deaths
                    var deaths = -1;
                    //k/d ratio
                    var kd = 0;
                    //User's name
                    var username;
                    //To keep track of rounds
                    var previousRound = 0;
                    //Terriorist's score
                    var tSide = 0;
                    //CT's score
                    var ctSide = 0;
                    //current player's side
                    var currPlayerSide;
                    //win or lose?
                    var winLose;
                    var winLose2;
                    //local numFile
                    var numFiles1
                    //database numFile
                    var numFiles2

                    const testFolder = 'C:\\Program Files (x86)\\Steam\\steamapps\\common\\Counter-Strike Global Offensive\\csgo\\replays\\';
                function load1()
                {
                    //Check to see current replay files
                    fs.readdir(testFolder, (err, files) =>
                    {
                      console.log("Num of replay files" + files.length)
                      localStorage.setItem("CSGO_Local_Files", files.length);



                      //Give permission to update columns in database
                  var sql_SAFE = "SET SQL_SAFE_UPDATES = 0"
                  connection.query(sql_SAFE, function (err, result)
                  {
                      if(err)
                      {
                          console.log("An error ocurred performing the query.");
                          console.log(err);
                          return;
                      }
                      console.log("CSGO SAFE Query succesfully executed");
                  });

                  //Checks numFiles that is in database
                 const query2 = "SELECT numFiles FROM new_table"
                 connection.query(query2, function (err, result, fields)
                 {
                    if (err) throw err;
                    console.log("CSGO numFiles Checked")
                    localStorage.setItem("CSGO_DB_Files", result[0].numFiles);
                });
             });
                    //Don't know why length in folder is 2 but says there are 3...
                 numFiles1 = (localStorage.getItem("CSGO_Local_Files"))
                 numFiles2 = localStorage.getItem("CSGO_DB_Files")
                 if(numFiles1 <= 0)
                 {
                    alert("Play a game of CSGO OR download replay files on steam!")
                 }


                }
                function load2()
                {
                    //Update database if new replay files were added, else just display tables
                    if(numFiles1 != numFiles2)
                    {
                      ipc.send('entry-accepted', 'ping4');
                      var sql3 = mysql.format("UPDATE new_table SET numFiles" + "='" + numFiles1 + "' WHERE id = 1")

                      // execute the insert statement
                      connection.query(sql3, function (err, result)
                      {
                          if(err)
                          {
                              console.log("An error ocurred performing the query.");
                              console.log(err);
                              return;
                          }
                          console.log("CSGO UPDATE Query succesfully executed");
                      });

                    fs.readdir(testFolder, (err, files) =>
                    {
                        var file = files[files.length - 1]

                        var csgo_month = fs.statSync(testFolder + file).mtime.getMonth()
                        var csgo_day = fs.statSync(testFolder + file).mtime.getDate()
                        var csgo_year = fs.statSync(testFolder + file).mtime.getFullYear()
                        var csgo_hours = fs.statSync(testFolder + file).mtime.getHours()
                        var csgo_mins = fs.statSync(testFolder + file).mtime.getMinutes()
                        var csgo_secs = fs.statSync(testFolder + file).mtime.getSeconds()

                        if(csgo_mins == 0)
                        {
                          csgo_mins = '00'
                        }
                        else if(csgo_mins == 1)
                        {
                          csgo_mins = '01'
                        }
                        else if(csgo_mins == 2)
                        {
                          csgo_mins = '02'
                        }
                        else if(csgo_mins == 3)
                        {
                          csgo_mins = '03'
                        }
                        else if(csgo_mins == 4)
                        {
                          csgo_mins = '04'
                        }
                        else if(csgo_mins == 5)
                        {
                          csgo_mins = '05'
                        }
                        else if(csgo_mins == 6)
                        {
                          csgo_mins = '06'
                        }
                        else if(csgo_mins == 7)
                        {
                          csgo_mins = '07'
                        }
                        else if(csgo_mins == 8)
                        {
                          csgo_mins = '08'
                        }
                        else if(csgo_mins == 9)
                        {
                          csgo_mins = '09'
                        }



                        if(csgo_hours == 13)
                        {
                          csgo_hours = 1
                          csgo_secs += "PM"
                        }
                        else if(csgo_hours == 14)
                        {
                          csgo_hours = 2
                          csgo_secs += "PM"
                        }
                        else if(csgo_hours == 15)
                        {
                          csgo_hours = 3
                          csgo_secs += "PM"
                        }
                        else if(csgo_hours == 16)
                        {
                          csgo_hours = 4
                          csgo_secs += "PM"
                        }
                        else if(csgo_hours == 17)
                        {
                          csgo_hours = 5
                          csgo_secs += "PM"
                        }
                        else if(csgo_hours == 18)
                        {
                          csgo_hours = 6
                          csgo_secs += "PM"
                        }
                        else if(csgo_hours == 19)
                        {
                          csgo_hours = 7
                          csgo_secs += "PM"
                        }
                        else if(csgo_hours == 20)
                        {
                          csgo_hours = 8
                          csgo_secs += "PM"
                        }
                        else if(csgo_hours == 21)
                        {
                          csgo_hours = 9
                          csgo_secs += "PM"
                        }
                        else if(csgo_hours == 22)
                        {
                          csgo_hours = 10
                          csgo_secs += "PM"
                        }
                        else if(csgo_hours == 23)
                        {
                          csgo_hours = 11
                          csgo_secs += "PM"
                        }
                        else if(csgo_hours == 24)
                        {
                          csgo_hours = 12
                          csgo_secs += "PM"
                        }


                        var date = ((csgo_month+1) +'-'+ csgo_day +'-'+ csgo_year);
                        var time = csgo_hours + ":" + csgo_mins + ":" + csgo_secs;
                        var dateTime = date +' '+ time;
                        //console.log(dateTime)

                        fs.readFile(testFolder + file, function(err,data)
                        {
                            var myDemo = new jsgo.Demo().

                            //Checks event of each round
                            on('game.round_officially_ended', function(event)
                            {
                                //Get teams
                                var teams = this.getTeams();
                                //Get players
                                var player = this.getPlayers();
                                var currentPlayer = "";
                                var currentPos = 0;

                                //Loop to find the user's name
                                for ( var i = 0; i < 20; i++)
                                {
                                    //Find username in replay file
                                    if (player[i].getName() == user)
                                    {
                                        currentPlayer = player[i].getName();
                                        currentPos = i;
                                        break;

                                    }
                                }

                                //Find the team that the user is in
                                //console.log(player[currentPos].getTeam(this)["classInfo"].name);

                                //if user is in CT, make that his/her current team
                                if(player[currentPos].getTeam(this)["classInfo"].name == 'CCSTeam')
                                {
                                    currPlayerSide = 'CT';
                                }
                                //if user is in terrorist, make that his/her current team
                                else
                                {
                                    currPlayerSide = 'TERRORIST';
                                }

                                //Checks rounds
                                //console.log('ROUND ' + (previousRound + 1));

                                previousRound = 0;
                                var teams = this.getTeams();

                                //Keeps track of score after each round
                                for (var i = 0; i < teams.length; i++)
                                {

                                    var team = teams[i];
                                    var side = team.getSide();

                                    //Set scores to team variables
                                    if(team.getSide() == 'TERRORIST')
                                    {
                                        tSide = team.getScore();
                                    }
                                    else if (team.getSide() == 'CT')
                                    {
                                        ctSide = team.getScore();
                                    }

                                    //Iterate round
                                    previousRound += team.getScore();


                                }
                                //To display scores/round
                                //console.log('TERRORIST' + " " + tSide);
                                //console.log('CT' + " " + ctSide);

                                //0 = win, 1 = lose, 2 = tie
                                if(tSide < ctSide && currPlayerSide == 'TERRORIST')
                                {
                                    winLose = 0;
                                }
                                else if (ctSide < tSide && currPlayerSide == 'CT')
                                {
                                    winLose = 0;
                                }
                                else if (ctSide == tSide)
                                {
                                    winLose = 2
                                }
                                else
                                {
                                    winLose = 1;
                                }

                                //Player's username
                                username = player[currentPos].getName();
                                //console.log("\n"+ username);

                                //Headshots
                                headshots += player[currentPos].getRoundHeadshotKills();
                                //console.log("Headshots: " + headshots);

                                //Kills
                                kills += player[currentPos].getRoundKills();
                                //console.log("Kills: " + kills);

                            }).

                            //Checks event of each death
                            on('game.player_death', function(e)
                            {
                                if (e.player != undefined)
                                {
                                    //console.log(e.player.getName());

                                    //If player's name is displayed, iterate death by 1
                                    if(e.player.getName() == user)
                                    {
                                        deaths++;
                                    }
                                }

                                //Deaths
                                //console.log("Deaths: " + deaths);

                                //Calculate K/D
                                kd = (kills/deaths);
                                //console.log("K/D: " + kd);
                            }).

                            parse(data);
                            console.log("\n"+ username);
                            console.log("Deaths: " + deaths);
                            console.log("K/D: " + kd.toFixed(2));
                            console.log("Kills: " + kills);
                            console.log("Headshots: " + headshots);
                            console.log("Win/Lose/Tie: " + winLose);

                            if (winLose == 0)
                            {
                                winLose2 = "Won"
                            }
                            else if (winLose == 1)
                            {
                                winLose2 = "Lost"
                            }
                            else
                            {
                                winLose2 = "Tied"
                            }

                            const query4 = "SELECT id FROM CSGO_stats"
                            connection.query(query4, function (err, result, fields)
                            {
                                if (err) throw err;
                                for(var p = 0; p<result.length; p++ )
                                {
                                    if (result[p].id == id2)
                                    {
                                        id2++
                                    }
                                }

                          //Writes data to database
                          var sql2 = mysql.format("INSERT INTO CSGO_stats (kills,deaths,kd,headshots,wtl,id, TIMESTAMP) VALUES (?, ?, ?, ? ,?, ?, ?)", [kills, deaths, kd.toFixed(2), headshots, winLose2, id2, dateTime]);

                          // execute the insert statement
                          connection.query(sql2, function (err, result)
                          {
                              if(err)
                              {
                                  console.log("An error ocurred performing the query.");
                                  console.log(err);
                                  return;
                              }
                              console.log("CSGO INSERT Query succesfully executed");
                              ipc.sendSync('entry-accepted', 'ping3');
                          });
                      });
                    });

                            console.log("Ended");

                    });
                }
                else
                {

                    const query2 = "SELECT KILLS, DEATHS, KD, HEADSHOTS, WTL, TIMESTAMP FROM CSGO_stats ORDER BY TIMESTAMP DESC"
                    connection.query(query2, function (err, result, fields)
                    {
                        if (err) throw err;
                        console.log("CSGO querying...")
                        table.displaySessionData(result, fields, "CS:GO-session-data-section")

                        //connection2.end();

                    });

                }
            }
if(loggedIn == 0)
{
    load1()
    load2()
}
    //Rerun load function every minute
    var c = 0;
    var t;
    var timer_is_on = 0;
    var checker = 0;
    var checker2 = 0

    //Optional Refresh button
    function reloadTables()
    {
        ipc.sendSync('entry-accepted', 'ping3');
    }

    function timedCount()
    {
        //load csgo session data
        load1()
        //load fortnite and csgo career data
        //loadIt()
        loadIt2()
        //If new replay file was added, run the function
        if((numFiles1 != numFiles2) && (checker == 1))
        {
            load2()
        }
        t = setTimeout(timedCount, 60000);
        checker = 1
    }

    function timedCount2()
    {
        //load fortnite session data
        FNload1()
        //If new replay file was added, run the function
        if((FNnumFiles1 != FNnumFiles2) && (checker2 == 1))
        {
            FNload2()
        }
        t = setTimeout(timedCount2, 60000);
        checker2 = 1

    }

    function startCount()
    {
      if (!timer_is_on)
      {
        timer_is_on = 1;
        timedCount();
        timedCount2()
      }
    }
if(loggedIn == 0)
{
    startCount();
}
                </script>

        </header>
    </section>


</template>
