<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Blast Desktop API</title>
    </head>
    <body>
        <h1>Your Fornite Stats</h1>
        <br>
        <table id="table" border="1">
            <tbody>
                
            </tbody>
        </table>
    </body>
    <script>
        let {PythonShell} = require('python-shell')
        var html;

        var Kills;
        var Assists;
        var Revives;
        var Accuracy;
        var DamageTaken;

        var mysql = require('mysql');
        var connection = mysql.createConnection({
            host: "MacBook-Air.local",
            user: "guest",
            password: "9879968b",
            database: "fortniteINFO"
        });
        PythonShell.run('Main.py',  null, function  (err, results)  
        {
            //Should read every replay file, not just one 
            var Kills = parseInt(results[1]);
            var Assists = parseInt(results[2]);
            var Revives = parseInt(results[3]);
            var Accuracy = parseInt(results[4]);
            var DamageTaken = parseInt(results[5]);

            var totalKills;
            var totalAssists;
            var totalRevives;
            var totalAccuracy;
            var totalDamageTaken;

            if  (err)  throw err;

            console.log('Main.py finished.');
            console.log('results', results);

            var mysql = require('mysql');

            getStats(function(rows)
            {
                html = '';

                rows.forEach(function(row)
                {
                  totalKills = row.TotalK;
                  totalAssists = row.TotalA;
                  totalRevives = row.TotalR;
                  totalAccuracy = row.TotalAcc;
                  totalDamageTaken = row.TotalDT;
                });

                
                    html += '<tr>';
                    html += '<th>';
                    html += 'Kills';
                    html += '</th>';
                    html += '<th>';
                    html += 'Assists';
                    html += '</th>';
                    html += '<th>';
                    html += 'Revives';
                    html += '</th>';
                    html += '<th>';
                    html += 'Accuracy';
                    html += '</th>';
                    html += '<th>';
                    html += 'Damage Taken';
                    html += '</th>';
                    html += '</tr>';
                    html += '<tr>';
                    html += '<td>';
                    html += totalKills;
                    html += '</td>';
                    html += '<td>';
                    html += totalAssists;
                    html += '</td>';
                    html += '<td>';
                    html += totalRevives;
                    html += '</td>';
                    html += '<td>';
                    html += totalAccuracy;
                    html += '</td>';
                    html += '<td>';
                    html += totalDamageTaken;
                    html += '</td>';
                    html += '</tr>';
                    
                //put html in table
                document.querySelector('#table > tbody').innerHTML = html;
            });


        function getStats(callback)
        {
             // connect to mysql
            connection.connect(function(err) 
            {
                // in case of error
                if(err){
                    console.log(err.code);
                    console.log(err.fatal);
                }
            });
            /*
            //Writes data to database!
             - Should make it auto run or add a button to constantly update database
             - Should stop adding old data to database 
            */
            /*
            var sql = mysql.format("INSERT INTO stats (kills,assists,revives,accuracy,damageTaken) VALUES (?, ?, ?, ? ,?)", [Kills, Assists, Revives, Accuracy, DamageTaken]);

            connection.query(sql, function (err, result) 
            // execute the insert statment
            {
                if(err)
                {
                    console.log("An error ocurred performing the query.");
                    console.log(err);
                    return;
                }

                console.log("INSERT Query succesfully executed");

            });
            */
            // Perform a query
            $query =  "SELECT SUM(kills) AS TotalK, SUM(assists) AS TotalA, SUM(revives) AS TotalR, SUM(accuracy) AS TotalAcc,SUM(damageTaken) AS TotalDT FROM stats;";



            connection.query($query, function(err, rows, fields, results) {
                if(err)
                {
                    console.log("An error ocurred performing the query.");
                    console.log(err);
                    return;
                }

                callback(rows);
                console.log(rows[0].TotalK);
            });


            // Close the connection
            connection.end(function(){
            });
        }
        });
    </script>
</html>
